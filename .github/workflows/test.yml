name: test

on:
  push:
    branches-ignore:
      - master

jobs:
  build-test:
    runs-on: macOS-latest
    
    steps:
    - uses: actions/checkout@v1

    - name: switch xcode version
      run: sudo xcode-select --switch /Applications/Xcode_12.app
    
    - uses: actions/cache@v2
      with:
        path: Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: install depencies
      run: pod install

    - name: build Fire.app
      run: ./scripts/a_build_app.sh

    - name: build FireInstaller.pkg
      run: ./scripts/b_build_installer.sh

    - name: generate appcast.xml
      env:
        sparkle_key: ${{ secrets.sparkle_key }}
      run: ./scripts/d_build_appcast.sh

    - uses: actions/upload-artifact@v2
      with:
        name: dist
        path: ./dist/
        retention-days: 3